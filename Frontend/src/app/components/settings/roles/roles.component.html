<!-- Modern Dashboard Container -->
<div class="min-h-[80vh] py-6">
    <div class="mx-auto space-y-8">
        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row justify-between items-start p-4 lg:items-center gap-3 lg:gap-4 mb-4 lg:mb-6">
            <div class="flex w-full items-center justify-between space-x-3 lg:space-x-5 w-full ">
              <div>
                <div class="space-y-1">
                  <div class="flex items-center space-x-3">
                    <h1 class="text-2xl sm:text-2xl font-semibold text-primary truncate">
                        Roles Management
                    </h1>
                  </div>
                  <div class="flex items-center">
                    <p class="text-sm text-gray-600 truncate">
                      Manage roles and permissions for your users.
                    </p>
                  </div>
                </div>
              </div>
              <div class="flex justify-end items-center">
                <div class="flex items-center space-x-4">     
                    <button (click)="openModal()" class="bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded-lg flex items-center">
                        <i class="ri-add-circle-line mr-2"></i>Create Role
                    </button>
                </div>
              </div>
            </div>
        </div>

        <!-- Skeleton Loading -->
        <div *ngIf="loading" class="rounded-2xl shadow-sm bg-white border border-[#e5e7eb] overflow-hidden">
            <div *ngFor="let i of [1,2,3]" class="border-b border-primary/10 last:border-b-0 animate-pulse">
                <div class="flex items-center justify-between p-5">
                    <div class="flex items-center">
                        <div class="bg-gray-200 dark:bg-gray-700 p-3 w-12 h-12 rounded-full mr-4"></div>
                        <div>
                            <div class="h-5 w-32 bg-gray-200 dark:bg-gray-700 rounded mb-2"></div>
                            <div class="h-4 w-48 bg-gray-200 dark:bg-gray-700 rounded"></div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="h-6 w-24 bg-gray-200 dark:bg-gray-700 rounded-full mr-4"></div>
                        <div class="h-5 w-5 bg-gray-200 dark:bg-gray-700 rounded"></div>
                    </div>
                </div>
            </div>
        </div>
 
        <!-- Main Content -->
        <div class="rounded-2xl shadow-sm border bg-white border border-[#e5e7eb] overflow-hidden" *ngIf="!loading">
            <div *ngFor="let role of filteredRoles; let i = index" class="border-b border-primary/10 last:border-b-0">
                <!-- Role Header -->
                <div (click)="selectRole(role.role_id)" class="flex items-center justify-between p-5 cursor-pointer hover:">
                    <div class="flex items-center">
                        <div class=" bg-primary p-3 w-12 h-12 flex items-center justify-center rounded-full mr-4">
                            <i class="ri-user-settings-line text-white   text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-main">{{role.name}}</h3>
                            <p class="text-sm text-main-light">{{role.description}}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-white bg-primary  px-2.5 py-1 rounded-full mr-4">
                            {{role.permissionsCount}} Resources
                        </span>
                        <svg [class.rotate-180]="role.role_id === selectedId" class="w-5 h-5 text-main/10 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>

                <!-- Role Permissions -->
                <div *ngIf="role.role_id === selectedId" class="border-t border-primary/10  p-5">
                    <div class="mb-4 flex justify-end">
                        <button (click)="applyChanges()" [disabled]="loading" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition-colors flex items-center">
                            <svg *ngIf="loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            {{ loading ? 'Saving...' : 'Save Changes' }}
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Resource</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">View</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Add</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Edit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Delete</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-primary/10">
                                <ng-container *ngFor="let resource of updatedRoles[role.role_id]">
                                    <!-- Main Resource Row -->
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <button *ngIf="resource.has_subresources" (click)="toggleResource(resource.resource_id)" class="mr-2 focus:outline-none">
                                                    <i [ngClass]="isExpanded(resource.resource_id) ? 'ri-arrow-down-s-line' : 'ri-arrow-right-s-line'" class="text-xl text-primary"></i>
                                                </button>
                                                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-full bg-primary">
                                                    <i [class]="resource.icon + ' text-white'"></i>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-main">{{resource.title}}</div>
                                                    <div *ngIf="resource.has_subresources" class="text-xs text-primary/60 mt-1">
                                                        <i class="ri-subtract-line mr-1"></i>Has subresources
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <input [id]="role.role_id + '-' + resource.resource_id + '-view'" 
                                                       type="checkbox" 
                                                       [checked]="resource.view"
                                                       (change)="updatePermission(role.role_id, resource.resource_id, 'view', $event)"
                                                       class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <input [id]="role.role_id + '-' + resource.resource_id + '-add'" 
                                                       type="checkbox" 
                                                       [checked]="resource.add"
                                                       (change)="updatePermission(role.role_id, resource.resource_id, 'add', $event)"
                                                       class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <input [id]="role.role_id + '-' + resource.resource_id + '-edit'" 
                                                       type="checkbox" 
                                                       [checked]="resource.edit"
                                                       (change)="updatePermission(role.role_id, resource.resource_id, 'edit', $event)"
                                                       class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <input [id]="role.role_id + '-' + resource.resource_id + '-delete'" 
                                                       type="checkbox" 
                                                       [checked]="resource.delete"
                                                       (change)="updatePermission(role.role_id, resource.resource_id, 'delete', $event)"
                                                       class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Subresources Accordion Section -->
                                    <ng-container *ngIf="resource.has_subresources && isExpanded(resource.resource_id)">
                                        <tr *ngFor="let sub of resource.subresources" class="hover:bg-gray-50 dark:hover:bg-gray-800/50 border-l-4 border-primary/20 bg-primary/5">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center pl-8">
                                                    <div class="flex-shrink-0 h-8 w-8 flex items-center justify-center rounded-full bg-primary/20">
                                                        <i [class]="sub.icon + ' text-primary'"></i>
                                                    </div>
                                                    <div class="ml-4">
                                                        <div class="text-sm font-medium text-main">{{sub.title}}</div>
                                                        <div class="text-xs text-primary/60 mt-1">
                                                            <i class="ri-link mr-1"></i>Subresource
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <input [id]="role.role_id + '-' + sub.resource_id + '-view'" 
                                                           type="checkbox" 
                                                           [checked]="sub.view"
                                                           (change)="updatePermission(role.role_id, sub.resource_id, 'view', $event)"
                                                           class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <input [id]="role.role_id + '-' + sub.resource_id + '-add'" 
                                                           type="checkbox" 
                                                           [checked]="sub.add"
                                                           (change)="updatePermission(role.role_id, sub.resource_id, 'add', $event)"
                                                           class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <input [id]="role.role_id + '-' + sub.resource_id + '-edit'" 
                                                           type="checkbox" 
                                                           [checked]="sub.edit"
                                                           (change)="updatePermission(role.role_id, sub.resource_id, 'edit', $event)"
                                                           class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <input [id]="role.role_id + '-' + sub.resource_id + '-delete'" 
                                                           type="checkbox" 
                                                           [checked]="sub.delete"
                                                           (change)="updatePermission(role.role_id, sub.resource_id, 'delete', $event)"
                                                           class="h-4 w-4 text-primary focus:ring-2 focus:ring-primary/20 focus:ring-offset-2 focus:ring-offset-theme-secondary border-primary/20 rounded transition-all duration-200 cursor-pointer hover:border-primary/40 checked:bg-primary checked:hover:bg-primary-dark">
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-container>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- No Results Message -->
            <div *ngIf="filteredRoles.length === 0 && !loading" class="p-8 text-center">
                <div class="flex flex-col items-center justify-center">
                    <i class="ri-search-line text-4xl text-primary/40 mb-2"></i>
                    <p class="text-primary/60">No roles found matching your search</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div *ngIf="isVisible" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
  <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-700" (click)="$event.stopPropagation()" @modalAnimation>
    <!-- Modal Header -->
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center space-x-2">
        <i class="ri-user-settings-line text-xl text-main"></i>
        <h3 class="text-xl font-bold text-main">Create New Role</h3>
      </div>
      <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>
    <div class="text-sm text-gray-500 mb-4">Define a new role and its permissions for your organization.</div>

    <!-- Modal Body -->
    <form [formGroup]="roleForm" class="space-y-6">
      <div>
        <h4 class="text-lg font-semibold text-main mb-2">Role Information</h4>
        <div class="space-y-4">
          <div>
            <label for="name" class="block mb-1 text-sm font-medium text-main">Role Name</label>
            <div class="relative">
              <i class="ri-user-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="name" formControlName="name"
                     class="w-full pl-10 pr-3 py-2 border border-gray-200 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-main dark:bg-gray-700 dark:text-white"
                     placeholder="Enter role name" />
            </div>
          </div>
          <div>
            <label for="description" class="block mb-1 text-sm font-medium text-main">Description</label>
            <div class="relative">
              <i class="ri-file-text-line absolute left-3 top-4 text-gray-400"></i>
              <textarea id="description" formControlName="description" rows="4"
                        class="w-full pl-10 pr-3 py-2 border border-gray-200 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-main dark:bg-gray-700 dark:text-white resize-none"
                        placeholder="Enter role description"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-6 space-x-3">
        <button type="button" (click)="closeModal()" 
                class="px-4 py-2 bg-white border border-primary rounded-md text-primary hover:bg-primary/5 transition-colors">
          Cancel
        </button>
        <button type="submit" (click)="onSubmit()" 
                class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition-colors flex items-center border border-primary/20">
          <ng-container *ngIf="loading; else buttonText">
            <svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </ng-container>
          <ng-template #buttonText>
            Create Role
          </ng-template>
        </button>
      </div>
    </form>
  </div>
</div>