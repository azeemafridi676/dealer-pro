<div class="container mx-auto py-6">
  <!-- Stats Cards Section -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- Total Invoiced Card -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-medium text-gray-500">Total Invoiced</h3>
        <div
          class="p-3 bg-primary/10 w-[3.5rem] h-[3.5rem] flex justify-center items-center rounded-full"
        >
          <i class="ri-file-text-line text-xl text-primary"></i>
        </div>
      </div>
      <div
        *ngIf="loading; else totalInvoicedContent"
        class="flex items-end gap-2"
      >
        <div class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
        <div class="h-4 w-12 bg-gray-100 rounded animate-pulse mb-1"></div>
      </div>
      <ng-template #totalInvoicedContent>
        <div class="flex items-end gap-2">
          <span class="text-3xl font-bold">{{ stats.totalInvoiceAmount | number : "1.0-0" }} kr</span>
          <span class="text-sm text-gray-500 mb-1">{{ stats.totalInvoices }} total invoices</span>
        </div>
        <div class="text-xs text-gray-500 mt-2">
          {{ getInvoicedAmountSummary() }}
        </div>
      </ng-template>
    </div>

    <!-- Outstanding Payments Card -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-medium text-gray-500">Outstanding Payments</h3>
        <div
          class="p-3 bg-red/10 w-[3.5rem] h-[3.5rem] flex justify-center items-center rounded-full"
        >
          <i class="ri-bank-card-line text-xl text-red-600"></i>
        </div>
      </div>
      <div
        *ngIf="loading; else outstandingPaymentsContent"
        class="flex items-end gap-2"
      >
        <div class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
        <div class="h-4 w-12 bg-gray-100 rounded animate-pulse mb-1"></div>
      </div>
      <ng-template #outstandingPaymentsContent>
        <div class="flex items-end gap-2">
          <span class="text-3xl font-bold">
            {{ stats.statusCounts.PENDING * stats.averageInvoiceAmount | number : "1.0-0" }} kr
          </span>
          <span class="text-sm text-gray-500 mb-1">{{ stats.statusCounts.PENDING }} pending invoices</span>
        </div>
        <div class="text-xs text-gray-500 mt-2">
          {{ getOutstandingPaymentsSummary() }}
        </div>
      </ng-template>
    </div>

    <!-- Paid Invoices Card -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-medium text-gray-500">Paid Invoices</h3>
        <div
          class="p-3 bg-green/10 w-[3.5rem] h-[3.5rem] flex justify-center items-center rounded-full"
        >
          <i class="ri-check-line text-xl text-green-600"></i>
        </div>
      </div>
      <div
        *ngIf="loading; else paidInvoicesContent"
        class="flex items-end gap-2"
      >
        <div class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
        <div class="h-4 w-12 bg-gray-100 rounded animate-pulse mb-1"></div>
      </div>
      <ng-template #paidInvoicesContent>
        <div class="flex items-end gap-2">
          <span class="text-3xl font-bold">
            {{ stats.statusCounts.PAID * stats.averageInvoiceAmount | number : "1.0-0" }} kr
          </span>
          <span class="text-sm text-gray-500 mb-1">{{ stats.statusCounts.PAID }} paid invoices</span>
        </div>
        <div class="text-xs text-gray-500 mt-2">
          {{ getPaidInvoicesSummary() }}
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Top Actions Section -->
  <form [formGroup]="filterForm">
    <div class="flex flex-wrap gap-[40%] mb-6">
      <div class="flex-1 w-30">
        <input
          type="text"
          placeholder="Search by Invoice Number, Customer..."
          class="form-input w-full rounded-xl border border-gray-200 px-4 py-3 h-12"
          formControlName="searchTerm"
        />
      </div>
      <div class="flex gap-2 relative">
        <!-- Filter Button (opens right-side panel) -->
        <button
          type="button"
          class="bg-white border border-gray-200 text-gray-700 px-4 py-2 h-12 rounded-xl flex items-center hover:bg-gray-50 transition shadow-sm"
          (click)="openFilterPanel()"
        >
          <i class="ri-filter-3-line mr-2"></i>Filter
        </button>
        <!-- Add Invoice Button -->
        <button
          type="button"
          (click)="navigateToAddInvoice()"
          class="bg-primary hover:bg-primary-dark text-white px-4 py-2 h-12 rounded-xl transition-colors flex items-center shadow-sm"
        >
          <i class="ri-add-line mr-2"></i>Add Invoice
        </button>
      </div>
    </div>
  </form>

  <!-- Right-side Filter Panel with Overlay -->
  <div *ngIf="showFilterPanel">
    <!-- Overlay -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity"
      (click)="closeFilterPanel()"
    ></div>
    <!-- Side Panel -->
    <div
      class="fixed top-0 right-0 h-full w-full sm:w-[400px] bg-white z-50 shadow-xl transition-transform duration-300"
      @modalAnimation
    >
      <div class="flex flex-col h-full">
        <div class="flex items-center justify-between p-6 border-b">
          <h2 class="text-xl font-bold">Filter Invoices</h2>
          <button
            (click)="closeFilterPanel()"
            class="text-gray-400 hover:text-gray-600 text-2xl"
          >
            <i class="ri-close-line"></i>
          </button>
        </div>
        <form [formGroup]="filterForm" class="flex-1 flex flex-col p-6 gap-4">
          <!-- Status -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Invoice Status</label>
            <div class="custom-select-wrapper">
              <div 
                class="custom-select-trigger"
                (click)="toggleStatusDropdown()"
                [class.active]="isStatusDropdownOpen"
              >
                <span class="select-text">
                  {{ filterForm.get('statusAdv')?.value || 'All Statuses' }}
                </span>
                <svg 
                  class="select-arrow" 
                  [class.rotated]="isStatusDropdownOpen"
                  xmlns="http://www.w3.org/2000/svg" 
                  width="20" 
                  height="20" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  stroke-width="2" 
                  stroke-linecap="round" 
                  stroke-linejoin="round"
                >
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </div>
              
              <div 
                class="custom-select-dropdown" 
                [class.show]="isStatusDropdownOpen"
              >
                <div class="select-options-container">
                  <div 
                    *ngFor="let option of statusOptions" 
                    class="select-option"
                    [class.selected]="option.value === filterForm.get('statusAdv')?.value"
                    (click)="selectStatusOption(option)"
                  >
                    <span>{{ option.label }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Customer Type -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Customer Type</label>
            <div class="custom-select-wrapper">
              <div 
                class="custom-select-trigger"
                (click)="toggleCustomerTypeDropdown()"
                [class.active]="isCustomerTypeDropdownOpen"
              >
                <span class="select-text">
                  {{ filterForm.get('customerTypeAdv')?.value || 'All Customer Types' }}
                </span>
                <svg 
                  class="select-arrow" 
                  [class.rotated]="isCustomerTypeDropdownOpen"
                  xmlns="http://www.w3.org/2000/svg" 
                  width="20" 
                  height="20" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  stroke-width="2" 
                  stroke-linecap="round" 
                  stroke-linejoin="round"
                >
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </div>
              
              <div 
                class="custom-select-dropdown" 
                [class.show]="isCustomerTypeDropdownOpen"
              >
                <div class="select-options-container">
                  <div 
                    *ngFor="let option of customerTypeOptions" 
                    class="select-option"
                    [class.selected]="option.value === filterForm.get('customerTypeAdv')?.value"
                    (click)="selectCustomerTypeOption(option)"
                  >
                    <span>{{ option.label }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- From Date -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">From Date</label>
            <input
              type="date"
              class="w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-gray-900 bg-gray-50"
              formControlName="fromDateAdv"
              placeholder="Start Date"
            />
          </div>

          <!-- To Date -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">To Date</label>
            <input
              type="date"
              class="w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-gray-900 bg-gray-50"
              formControlName="toDateAdv"
              placeholder="End Date"
            />
          </div>

          <!-- Min Amount -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Min Amount (kr)</label>
            <input
              type="number"
              class="w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-gray-900 bg-gray-50"
              formControlName="minAmountAdv"
              placeholder="Minimum Amount"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Max Amount -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Max Amount (kr)</label>
            <input
              type="number"
              class="w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-gray-900 bg-gray-50"
              formControlName="maxAmountAdv"
              placeholder="Maximum Amount"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Sorting -->
          <div>
            <label class="block text-gray-700 font-medium mb-2">Sort By</label>
            <div class="custom-select-wrapper">
              <div 
                class="custom-select-trigger"
                (click)="toggleSortDropdown()"
                [class.active]="isSortDropdownOpen"
              >
                <span class="select-text">
                  {{ getSortLabel() }}
                </span>
                <svg 
                  class="select-arrow" 
                  [class.rotated]="isSortDropdownOpen"
                  xmlns="http://www.w3.org/2000/svg" 
                  width="20" 
                  height="20" 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="currentColor" 
                  stroke-width="2" 
                  stroke-linecap="round" 
                  stroke-linejoin="round"
                >
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </div>
              
              <div 
                class="custom-select-dropdown" 
                [class.show]="isSortDropdownOpen"
              >
                <div class="select-options-container">
                  <div 
                    *ngFor="let option of sortOptions" 
                    class="select-option"
                    [class.selected]="option.value === filterForm.get('sortAdv')?.value"
                    (click)="selectSortOption(option)"
                  >
                    <span>{{ option.label }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-between mt-auto">
            <button
              type="button"
              (click)="resetFilterPanel()"
              class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
            >
              Reset
            </button>
            <button
              type="button"
              (click)="applyFilterPanel()"
              class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition"
            >
              Apply Filter
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Invoices Table -->
  <div
    class="rounded-xl shadow overflow-hidden border border-primary/10 bg-white"
  >
    <div class="overflow-x-auto relative">
      <!-- Loading Error Message -->
      <div *ngIf="loadingError" class="p-4 text-center text-red-500 bg-red-50">
        {{ loadingError }}
        <button
          (click)="loadInvoices()"
          class="ml-2 text-primary hover:underline"
        >
          Try Again
        </button>
      </div>

      <!-- Skeleton Loading -->
      <table 
        *ngIf="loading"
        class="min-w-full rounded-xl overflow-hidden bg-white shadow"
      >
        <thead>
          <tr>
            <th class="w-10 px-6 py-3"></th>
            <th 
              *ngFor="let col of selectedColumns"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
            >
              <div class="h-4 w-24 bg-gray-200 rounded animate-pulse"></div>
            </th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">
              <div class="h-4 w-10 bg-gray-200 rounded animate-pulse"></div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr 
            *ngFor="let _ of [1,2,3,4,5]" 
            class="border-b last:border-b-0 animate-pulse"
          >
            <td class="text-center px-2 py-4">
              <div class="h-6 w-6 bg-gray-200 rounded-full mx-auto"></div>
            </td>
            <td *ngFor="let col of selectedColumns" class="px-6 py-4">
              <div class="h-4 w-32 bg-gray-200 rounded"></div>
            </td>
            <td class="px-6 py-4 text-right">
              <div class="h-6 w-10 bg-gray-200 rounded mx-auto"></div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Actual Table -->
      <table 
        *ngIf="!loading"
        class="min-w-full rounded-xl overflow-hidden bg-white shadow"
      >
        <thead class="rounded-lg">
          <tr>
            <th class="w-10 px-6 py-3"></th>
            <th 
              *ngFor="let col of selectedColumns"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
            >
              {{ col }}
            </th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">
              <button 
                (click)="showColumnSettings = true"
                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                <i class="ri-settings-3-line text-xl"></i>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Debug No Columns State -->
          <tr *ngIf="selectedColumns.length === 0">
            <td colspan="10" class="text-center py-4 text-red-500">
              NO COLUMNS SELECTED. Check column settings and initialization.
            </td>
          </tr>

          <!-- Debug No Invoices State -->
          <tr *ngIf="!loading && paginatedInvoices.length === 0">
            <td [attr.colspan]="selectedColumns.length + 2" class="text-center py-8 text-gray-500">
              No Invoices found.
            </td>
          </tr>

          <!-- Invoice Rows -->
          <ng-container *ngFor="let invoice of paginatedInvoices; let i = index">
            <tr
              class="border-b last:border-b-0 hover:bg-gray-50 cursor-pointer select-none text-gray-900"
              (click)="toggleAccordion(getRowKey(invoice, i), invoice)"
            >
              <td class="text-center px-2">
                <button
                  class="flex items-center justify-center text-gray-500 text-2xl"
                  [ngClass]="{
                    'rotate-90 text-primary':
                      expandedRowKey === getRowKey(invoice, i)
                  }"
                  aria-label="Expand details"
                >
                  <i class="ri-arrow-right-s-line"></i>
                </button>
              </td>
              <td *ngFor="let col of selectedColumns" class="px-6 py-4 text-sm">
                @switch (col) { 
                  @case ('INVOICE #') {
                    {{ invoice.receiptNumber }}
                  } 
                  @case ('CUSTOMER') {
                    {{ invoice.customerName }}
                  } 
                  @case ('AMOUNT') {
                    {{ invoice.totalAmount | number : "1.0-0" }} kr
                  } 
                  @case ('ISSUE DATE') {
                    {{ invoice.issueDate | date : "dd/MM/yyyy" }}
                  } 
                  @case ('DUE DATE') {
                    {{ invoice.dueDate | date : "dd/MM/yyyy" }}
                  } 
                  @case ('STATUS') {
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700" [ngClass]="getStatusColor(invoice.status)">
                      {{ getStatusDisplay(invoice.status) }}
                    </span>
                  }
                  @case ('CUSTOMER TYPE') {
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                      {{ invoice.customerType || 'N/A' }}
                    </span>
                  }
                  @default {
                    {{ getColumnValue(invoice, col) }}
                  }
                }
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex justify-end space-x-2">
                  <button 
                    class="text-red-600 hover:text-red-800" 
                    title="Delete"
                    (click)="$event.stopPropagation(); confirmDeleteInvoice(invoice)"
                  >
                    <i class="ri-delete-bin-line text-2xl"></i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Expanded Row Details -->
            <tr *ngIf="expandedRowKey === getRowKey(invoice, i)">
              <td colspan="8" class="p-0">
                <div class="bg-gray-50 p-6">
                  <!-- First Section: 3 Columns -->
                  <div class="grid grid-cols-3 gap-6 mb-6">
                    <!-- Invoice Details Column -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                      <h3 class="text-lg font-semibold mb-4">Invoice Details</h3>
                      <div class="space-y-2">
                        <div>
                          <label class="text-xs text-gray-500">Invoice Number:</label>
                          <p class="text-sm font-medium">{{ invoice.receiptNumber }}</p>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Customer:</label>
                          <p class="text-sm font-medium">{{ invoice.customerName }}</p>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Customer Type:</label>
                          <div class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 w-max">
                            {{ invoice.customerType || 'N/A' }}
                          </div>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Total Amount:</label>
                          <p class="text-sm font-medium">{{ invoice.totalAmount | number : "1.0-0" }} kr</p>
                        </div>
                      </div>
                    </div>

                    <!-- Payment Information Column -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                      <h3 class="text-lg font-semibold mb-4">Payment Information</h3>
                      <div class="space-y-2">
                        <div>
                          <label class="text-xs text-gray-500">Status:</label>
                          <div class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 w-max" [ngClass]="getStatusColor(invoice.status)">
                            {{ getStatusDisplay(invoice.status) }}
                          </div>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Organization Number:</label>
                          <p class="text-sm font-medium">{{ invoice.organizationNumber || 'N/A' }}</p>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Legal Form:</label>
                          <p class="text-sm font-medium">{{ invoice.legalForm || 'N/A' }}</p>
                        </div>
                      </div>
                    </div>

                    <!-- Notes Column -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                      <h3 class="text-lg font-semibold mb-4">Business Details</h3>
                      <div class="space-y-2">
                        <div>
                          <label class="text-xs text-gray-500">Business Category:</label>
                          <p class="text-sm text-gray-700">{{ invoice.businessCategory || 'N/A' }}</p>
                        </div>
                        <div>
                          <label class="text-xs text-gray-500">Business Description:</label>
                          <p class="text-sm text-gray-700">{{ invoice.businessDescription || 'No description' }}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Second Section: Full Width Invoice Items -->
                  <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold mb-4">Invoice Items</h3>
                    <table class="w-full text-sm rounded-lg shadow-sm overflow-hidden border border-gray-200">
                      <thead class="rounded-lg">
                        <tr class="border-b">
                          <th class="text-center py-2">Product</th>
                          <th class="text-right py-2">Quantity</th>
                          <th class="text-right py-2">Unit</th>
                          <th class="text-right py-2">Price Excl. VAT</th>
                          <th class="text-right py-2">VAT Rate</th>
                          <th class="text-center py-2">Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of invoice.invoiceItems" class="border-b last:border-b-0">
                          <td class="py-2">{{ item.product }}</td>
                          <td class="text-right py-2">{{ item.number }}</td>
                          <td class="text-right py-2">{{ item.unit }}</td>
                          <td class="text-right py-2">{{ item.priceExclVAT | number : '1.0-0' }} kr</td>
                          <td class="text-right py-2">{{ item.vatRate * 100 }}%</td>
                          <td class="text-right py-2">{{ item.amount | number : '1.0-0' }} kr</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Third Section: Buttons Aligned to Right -->
                  <div class="flex justify-end space-x-4">
                    <button class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                      <i class="ri-download-line"></i> Download PDF
                    </button>
                    <button class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                      <i class="ri-file-text-line"></i> View Full Invoice
                    </button>
                    <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark flex items-center gap-2">
                      <i class="ri-edit-line"></i> Edit Invoice
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div
    *ngIf="!loading && totalItems > 0"
    class="mt-6 flex justify-between items-center"
  >
    <div class="text-sm text-gray-500">
      Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
      {{
        currentPage * itemsPerPage > totalItems
          ? totalItems
          : currentPage * itemsPerPage
      }}
      of {{ totalItems }} items
    </div>
    <nav aria-label="Pagination" class="flex space-x-1">
      <button
        [disabled]="currentPage === 1"
        (click)="changePage(currentPage - 1)"
        class="p-2 rounded-full border border-gray-200 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        aria-label="Previous page"
      >
        <i class="ri-arrow-left-s-line"></i>
      </button>
      <ng-container *ngFor="let page of getDisplayedPageNumbers()">
        <button
          (click)="changePage(page)"
          [ngClass]="{
            'bg-primary text-white hover:bg-primary/90': page === currentPage,
            'bg-white text-gray-500 hover:bg-gray-50': page !== currentPage
          }"
          class="h-9 w-9 flex items-center justify-center rounded-full border border-gray-200"
        >
          {{ page }}
        </button>
      </ng-container>
      <button
        [disabled]="currentPage === totalPages || totalPages === 0"
        (click)="changePage(currentPage + 1)"
        class="p-2 rounded-full border border-gray-200 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        aria-label="Next page"
      >
        <i class="ri-arrow-right-s-line"></i>
      </button>
    </nav>
  </div>

  <!-- Delete Confirmation Modal -->
  <div 
    *ngIf="showDeleteModal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-xl w-full max-w-md p-8 border border-gray-200 relative shadow-xl flex flex-col items-center"
    >
      <button
        (click)="showDeleteModal = false"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl"
      >
        <i class="ri-close-line"></i>
      </button>
      <i class="ri-delete-bin-line text-primary text-4xl mb-4"></i>
      <h2 class="text-xl font-bold text-gray-900 mb-2">Delete Invoice</h2>
      <p class="text-gray-600 mb-6 text-center">
        Are you sure you want to delete this invoice? This action cannot be undone.
      </p>
      <div class="flex gap-4 w-full justify-center">
        <button
          type="button"
          (click)="showDeleteModal = false"
          class="px-5 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="deleteInvoice()"
          [disabled]="loading"
          class="px-5 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition flex items-center gap-2"
        >
          <svg
            *ngIf="loading"
            class="animate-spin h-4 w-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          {{ loading ? "Deleting..." : "Delete" }}
        </button>
      </div>
    </div>
  </div>

  <!-- Column Settings Modal -->
  <div
    *ngIf="showColumnSettings"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-xl shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col"
    >
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b">
        <h2 class="text-xl font-semibold">Column Settings</h2>
        <button
          (click)="showColumnSettings = false"
          class="text-gray-500 hover:text-gray-700"
        >
          <i class="ri-close-line text-2xl"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="p-6 overflow-y-auto flex-1">
        <div class="flex gap-8">
          <!-- Available Columns -->
          <div class="flex-1 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold mb-4">Available Columns</h3>
            <div class="text-sm text-gray-500 mb-2">
              Total: {{ availableColumns.length }}
            </div>
            <div class="overflow-y-auto flex-1 max-h-[250px]">
              @for (col of availableColumns; track col) {
              <div
                class="flex items-center justify-between p-3 border-b last:border-b-0 hover:bg-gray-50"
              >
                <span class="text-gray-900">{{ col }}</span>
                <button
                  (click)="addColumn(col)"
                  class="text-primary hover:text-primary-dark"
                >
                  <i class="ri-add-line text-xl"></i>
                </button>
              </div>
              }
            </div>
          </div>

          <!-- Selected Columns -->
          <div class="flex-1 flex flex-col min-h-0">
            <h3 class="text-lg font-semibold mb-4">Selected Columns</h3>
            <div class="text-sm text-gray-500 mb-2">
              Total: {{ selectedColumns.length }}
            </div>
            <div
              class="overflow-y-auto flex-1 max-h-[250px]"
              cdkDropList
              #selectedList="cdkDropList"
              [cdkDropListData]="selectedColumns"
              (cdkDropListDropped)="onColumnDrop($event)"
            >
              @for (col of selectedColumns; track col) {
              <div
                class="flex items-center justify-between p-3 border-b last:border-b-0 hover:bg-gray-50"
                cdkDrag
              >
                <div class="flex items-center gap-2">
                  <i class="ri-drag-move-line text-gray-400"></i>
                  <span class="text-gray-900">{{ col }}</span>
                </div>
                <button
                  (click)="removeColumn($index)"
                  class="text-gray-500 hover:text-gray-700"
                >
                  <i class="ri-close-line text-xl"></i>
                </button>
              </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-end gap-4 p-6 border-t">
        <button
          (click)="showColumnSettings = false"
          class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition"
        >
          Cancel
        </button>
        <button
          (click)="saveColumnSettings()"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
